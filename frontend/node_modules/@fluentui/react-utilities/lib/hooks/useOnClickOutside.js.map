{"version":3,"sources":["useOnClickOutside.ts"],"sourcesContent":["import * as React from 'react';\nimport { useEventCallback } from './useEventCallback';\n\n/**\n * @internal\n */\nexport type UseOnClickOrScrollOutsideOptions = {\n  /**\n   * The element to listen for the click event\n   */\n  element: Document | undefined;\n  /**\n   * Refs to elements that check if the click is outside\n   */\n  refs: React.MutableRefObject<HTMLElement | undefined | null>[];\n\n  /**\n   * By default uses element.contains, but custom contain function can be provided\n   *\n   * @param parent - provided parent element\n   * @param child - event target element\n   */\n  contains?(parent: HTMLElement | null, child: HTMLElement): boolean;\n\n  /**\n   * Disables event listeners\n   */\n  disabled?: boolean;\n\n  /**\n   * Called if the click is outside the element refs\n   */\n  callback: (ev: MouseEvent | TouchEvent) => void;\n};\n\n/**\n * @internal\n * Utility to perform checks where a click/touch event was made outside a component\n */\nexport const useOnClickOutside = (options: UseOnClickOrScrollOutsideOptions) => {\n  const { refs, callback, element, disabled, contains: containsProp } = options;\n  const timeoutId = React.useRef<number | undefined>(undefined);\n  useIFrameFocus(options);\n\n  const listener = useEventCallback((ev: MouseEvent | TouchEvent) => {\n    const contains: UseOnClickOrScrollOutsideOptions['contains'] =\n      containsProp || ((parent, child) => !!parent?.contains(child));\n\n    const target = ev.composedPath()[0] as HTMLElement;\n    const isOutside = refs.every(ref => !contains(ref.current || null, target));\n\n    if (isOutside && !disabled) {\n      callback(ev);\n    }\n  });\n\n  React.useEffect(() => {\n    if (disabled) {\n      return;\n    }\n\n    // Store the current event to avoid triggering handlers immediately\n    // Note this depends on a deprecated but extremely well supported quirk of the web platform\n    // https://github.com/facebook/react/issues/20074\n    let currentEvent = getWindowEvent(window);\n\n    const conditionalHandler = (event: MouseEvent | TouchEvent) => {\n      // Skip if this event is the same as the one running when we added the handlers\n      if (event === currentEvent) {\n        currentEvent = undefined;\n        return;\n      }\n\n      listener(event);\n    };\n\n    // use capture phase because React can update DOM before the event bubbles to the document\n    element?.addEventListener('click', conditionalHandler, true);\n    element?.addEventListener('touchstart', conditionalHandler, true);\n    element?.addEventListener('contextmenu', conditionalHandler, true);\n\n    // Garbage collect this event after it's no longer useful to avoid memory leaks\n    timeoutId.current = window.setTimeout(() => {\n      currentEvent = undefined;\n    }, 1);\n\n    return () => {\n      element?.removeEventListener('click', conditionalHandler, true);\n      element?.removeEventListener('touchstart', conditionalHandler, true);\n      element?.removeEventListener('contextmenu', conditionalHandler, true);\n\n      clearTimeout(timeoutId.current);\n      currentEvent = undefined;\n    };\n  }, [listener, element, disabled]);\n};\n\nconst getWindowEvent = (target: Node | Window): Event | undefined => {\n  if (target) {\n    if (typeof (target as Window).window === 'object' && (target as Window).window === target) {\n      // eslint-disable-next-line deprecation/deprecation\n      return target.event;\n    }\n\n    // eslint-disable-next-line deprecation/deprecation\n    return (target as Node).ownerDocument?.defaultView?.event ?? undefined;\n  }\n\n  return undefined;\n};\n\nconst FUI_FRAME_EVENT = 'fuiframefocus';\n\ninterface UseIFrameFocusOptions extends UseOnClickOrScrollOutsideOptions {\n  /**\n   * Millisecond duration to poll\n   */\n  pollDuration?: number;\n}\n\n/**\n * Since click events do not propagate past iframes, we use focus to detect if a\n * click has happened inside an iframe, since the only ways of focusing inside an\n * iframe are:\n *   - clicking inside\n *   - tabbing inside\n *\n * Polls the value of `document.activeElement`. If it is an iframe, then dispatch\n * a custom DOM event. When the custom event is received call the provided callback\n */\nconst useIFrameFocus = (options: UseIFrameFocusOptions) => {\n  const {\n    disabled,\n    element: targetDocument,\n    callback,\n    contains: containsProp = (parent, child) => !!parent?.contains(child),\n    pollDuration = 1000,\n    refs,\n  } = options;\n  const timeoutRef = React.useRef<number>();\n\n  const listener = useEventCallback((e: Event) => {\n    const contains = containsProp || ((parent, child) => !!parent?.contains(child));\n\n    const isOutside = refs.every(ref => !contains(ref.current || null, e.target as HTMLElement));\n    if (isOutside && !disabled) {\n      callback(e as MouseEvent);\n    }\n  });\n\n  // Adds listener to the custom iframe focus event\n  React.useEffect(() => {\n    if (disabled) {\n      return;\n    }\n\n    targetDocument?.addEventListener(FUI_FRAME_EVENT, listener, true);\n\n    return () => {\n      targetDocument?.removeEventListener(FUI_FRAME_EVENT, listener, true);\n    };\n  }, [targetDocument, disabled, listener]);\n\n  // Starts polling for the active element\n  React.useEffect(() => {\n    if (disabled) {\n      return;\n    }\n\n    timeoutRef.current = targetDocument?.defaultView?.setInterval(() => {\n      const activeElement = targetDocument?.activeElement;\n\n      if (activeElement?.tagName === 'IFRAME' || activeElement?.tagName === 'WEBVIEW') {\n        const event = new CustomEvent(FUI_FRAME_EVENT, { bubbles: true });\n        activeElement.dispatchEvent(event);\n      }\n    }, pollDuration);\n\n    return () => {\n      targetDocument?.defaultView?.clearTimeout(timeoutRef.current);\n    };\n  }, [targetDocument, disabled, pollDuration]);\n};\n"],"names":["React","useEventCallback","useOnClickOutside","options","refs","callback","element","disabled","contains","containsProp","timeoutId","useRef","undefined","useIFrameFocus","listener","ev","parent","child","target","composedPath","isOutside","every","ref","current","useEffect","currentEvent","getWindowEvent","window","conditionalHandler","event","addEventListener","setTimeout","removeEventListener","clearTimeout","ownerDocument","defaultView","FUI_FRAME_EVENT","targetDocument","pollDuration","timeoutRef","e","setInterval","activeElement","tagName","CustomEvent","bubbles","dispatchEvent"],"mappings":"AAAA,YAAYA,WAAW,QAAQ;AAC/B,SAASC,gBAAgB,QAAQ,qBAAqB;AAkCtD;;;CAGC,GACD,OAAO,MAAMC,oBAAoB,CAACC,UAA8C;IAC9E,MAAM,EAAEC,KAAI,EAAEC,SAAQ,EAAEC,QAAO,EAAEC,SAAQ,EAAEC,UAAUC,aAAY,EAAE,GAAGN;IACtE,MAAMO,YAAYV,MAAMW,MAAM,CAAqBC;IACnDC,eAAeV;IAEf,MAAMW,WAAWb,iBAAiB,CAACc,KAAgC;QACjE,MAAMP,WACJC,gBAAiB,CAAA,CAACO,QAAQC;YAAU,OAAA,CAAC,EAACD,mBAAAA,oBAAAA,KAAAA,IAAAA,OAAQR,QAAQ,CAACS;SAAK;QAE9D,MAAMC,SAASH,GAAGI,YAAY,EAAE,CAAC,EAAE;QACnC,MAAMC,YAAYhB,KAAKiB,KAAK,CAACC,CAAAA,MAAO,CAACd,SAASc,IAAIC,OAAO,IAAI,IAAI,EAAEL;QAEnE,IAAIE,aAAa,CAACb,UAAU;YAC1BF,SAASU;QACX,CAAC;IACH;IAEAf,MAAMwB,SAAS,CAAC,IAAM;QACpB,IAAIjB,UAAU;YACZ;QACF,CAAC;QAED,mEAAmE;QACnE,2FAA2F;QAC3F,iDAAiD;QACjD,IAAIkB,eAAeC,eAAeC;QAElC,MAAMC,qBAAqB,CAACC,QAAmC;YAC7D,+EAA+E;YAC/E,IAAIA,UAAUJ,cAAc;gBAC1BA,eAAeb;gBACf;YACF,CAAC;YAEDE,SAASe;QACX;QAEA,0FAA0F;QAC1FvB,oBAAAA,qBAAAA,KAAAA,IAAAA,QAASwB,gBAAgB,CAAC,SAASF,oBAAoB,IAAI;QAC3DtB,oBAAAA,qBAAAA,KAAAA,IAAAA,QAASwB,gBAAgB,CAAC,cAAcF,oBAAoB,IAAI;QAChEtB,oBAAAA,qBAAAA,KAAAA,IAAAA,QAASwB,gBAAgB,CAAC,eAAeF,oBAAoB,IAAI;QAEjE,+EAA+E;QAC/ElB,UAAUa,OAAO,GAAGI,OAAOI,UAAU,CAAC,IAAM;YAC1CN,eAAeb;QACjB,GAAG;QAEH,OAAO,IAAM;YACXN,oBAAAA,qBAAAA,KAAAA,IAAAA,QAAS0B,mBAAmB,CAAC,SAASJ,oBAAoB,IAAI;YAC9DtB,oBAAAA,qBAAAA,KAAAA,IAAAA,QAAS0B,mBAAmB,CAAC,cAAcJ,oBAAoB,IAAI;YACnEtB,oBAAAA,qBAAAA,KAAAA,IAAAA,QAAS0B,mBAAmB,CAAC,eAAeJ,oBAAoB,IAAI;YAEpEK,aAAavB,UAAUa,OAAO;YAC9BE,eAAeb;QACjB;IACF,GAAG;QAACE;QAAUR;QAASC;KAAS;AAClC,EAAE;AAEF,MAAMmB,iBAAiB,CAACR,SAA6C;IACnE,IAAIA,QAAQ;YAOH;QANP,IAAI,OAAO,AAACA,OAAkBS,MAAM,KAAK,YAAY,AAACT,OAAkBS,MAAM,KAAKT,QAAQ;YACzF,mDAAmD;YACnD,OAAOA,OAAOW,KAAK;QACrB,CAAC;YAGM;QADP,mDAAmD;QACnD,OAAO,CAAA,0CAAA,CAAA,wBAAA,AAACX,OAAgBgB,aAAa,cAA9B,mCAAA,KAAA,IAAA,qCAAA,sBAAgCC,wEAAhC,KAAA,sCAA6CN,KAAF,cAA3C,qDAAA,0CAAsDjB,SAAS;IACxE,CAAC;IAED,OAAOA;AACT;AAEA,MAAMwB,kBAAkB;AASxB;;;;;;;;;CASC,GACD,MAAMvB,iBAAiB,CAACV,UAAmC;IACzD,MAAM,EACJI,SAAQ,EACRD,SAAS+B,eAAc,EACvBhC,SAAQ,EACRG,UAAUC,eAAe,CAACO,QAAQC;QAAU,OAAA,CAAC,EAACD,mBAAAA,oBAAAA,KAAAA,IAAAA,OAAQR,QAAQ,CAACS;KAAM,CAAA,EACrEqB,cAAe,KAAI,EACnBlC,KAAI,EACL,GAAGD;IACJ,MAAMoC,aAAavC,MAAMW,MAAM;IAE/B,MAAMG,WAAWb,iBAAiB,CAACuC,IAAa;QAC9C,MAAMhC,WAAWC,gBAAiB,CAAA,CAACO,QAAQC;YAAU,OAAA,CAAC,EAACD,mBAAAA,oBAAAA,KAAAA,IAAAA,OAAQR,QAAQ,CAACS;SAAK;QAE7E,MAAMG,YAAYhB,KAAKiB,KAAK,CAACC,CAAAA,MAAO,CAACd,SAASc,IAAIC,OAAO,IAAI,IAAI,EAAEiB,EAAEtB,MAAM;QAC3E,IAAIE,aAAa,CAACb,UAAU;YAC1BF,SAASmC;QACX,CAAC;IACH;IAEA,iDAAiD;IACjDxC,MAAMwB,SAAS,CAAC,IAAM;QACpB,IAAIjB,UAAU;YACZ;QACF,CAAC;QAED8B,2BAAAA,4BAAAA,KAAAA,IAAAA,eAAgBP,gBAAgB,CAACM,iBAAiBtB,UAAU,IAAI;QAEhE,OAAO,IAAM;YACXuB,2BAAAA,4BAAAA,KAAAA,IAAAA,eAAgBL,mBAAmB,CAACI,iBAAiBtB,UAAU,IAAI;QACrE;IACF,GAAG;QAACuB;QAAgB9B;QAAUO;KAAS;IAEvC,wCAAwC;IACxCd,MAAMwB,SAAS,CAAC,IAAM;YAKCa;QAJrB,IAAI9B,UAAU;YACZ;QACF,CAAC;QAEDgC,WAAWhB,OAAO,GAAGc,2BAAAA,4BAAAA,KAAAA,IAAAA,CAAAA,8BAAAA,eAAgBF,WAAW,cAA3BE,yCAAAA,KAAAA,IAAAA,4BAA6BI,YAAY,IAAM;YAClE,MAAMC,gBAAgBL,2BAAAA,4BAAAA,KAAAA,IAAAA,eAAgBK,aAAa;YAEnD,IAAIA,CAAAA,0BAAAA,2BAAAA,KAAAA,IAAAA,cAAeC,OAAO,AAAD,MAAM,YAAYD,CAAAA,0BAAAA,2BAAAA,KAAAA,IAAAA,cAAeC,OAAO,AAAD,MAAM,WAAW;gBAC/E,MAAMd,QAAQ,IAAIe,YAAYR,iBAAiB;oBAAES,SAAS,IAAI;gBAAC;gBAC/DH,cAAcI,aAAa,CAACjB;YAC9B,CAAC;QACH,GAAGS;QAEH,OAAO,IAAM;gBACXD;YAAAA,2BAAAA,4BAAAA,KAAAA,IAAAA,CAAAA,8BAAAA,eAAgBF,WAAW,cAA3BE,yCAAAA,KAAAA,IAAAA,4BAA6BJ,aAAaM,WAAWhB,OAAO;QAC9D;IACF,GAAG;QAACc;QAAgB9B;QAAU+B;KAAa;AAC7C"}