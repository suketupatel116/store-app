{"version":3,"sources":["useToaster.ts"],"sourcesContent":["import * as React from 'react';\nimport { isHTMLElement, useEventCallback, useForceUpdate } from '@fluentui/react-utilities';\nimport { useFluent_unstable as useFluent } from '@fluentui/react-shared-contexts';\nimport { createToaster } from './vanilla';\nimport type {\n  CommonToastDetail,\n  ShowToastEventDetail,\n  Toast,\n  ToastListenerMap,\n  ToastPosition,\n  ToasterId,\n  ToasterOptions,\n} from './types';\nimport { EVENTS } from './constants';\n\nexport function useToaster<TElement extends HTMLElement = HTMLDivElement>(options: Partial<ToasterOptions> = {}) {\n  const forceUpdate = useForceUpdate();\n  const { toasterId: userToasterId, shortcuts } = options;\n  // Currently the toaster options can never be changed at runtime\n  const [toaster] = React.useState(() => createToaster(options));\n  const { targetDocument } = useFluent();\n\n  const lastActiveElementRef = React.useRef<HTMLElement | null>(null);\n\n  const isCorrectToaster = useEventCallback((toasterId: ToasterId | undefined) => {\n    return toasterId === userToasterId;\n  });\n\n  const isFocusShortcut = useEventCallback((e: KeyboardEvent) => {\n    if (shortcuts?.focus) {\n      return shortcuts.focus(e);\n    }\n  });\n\n  const tryRestoreFocus = React.useCallback(() => {\n    lastActiveElementRef.current?.focus();\n    lastActiveElementRef.current = null;\n  }, []);\n\n  const pauseAllToasts = React.useCallback(() => {\n    toaster.visibleToasts.forEach(toastId => {\n      const toast = toaster.toasts.get(toastId);\n      toast?.imperativeRef.current?.pause();\n    });\n  }, [toaster]);\n\n  const playAllToasts = React.useCallback(() => {\n    toaster.visibleToasts.forEach(toastId => {\n      const toast = toaster.toasts.get(toastId);\n      toast?.imperativeRef.current?.play();\n    });\n  }, [toaster]);\n\n  const getMostRecentVisibleToast = React.useCallback(() => {\n    return Array.from(toaster.visibleToasts).reduce((cur, next) => {\n      const toast = toaster.toasts.get(next);\n      if (!toast) {\n        return cur;\n      }\n\n      if (!cur) {\n        return toast;\n      }\n\n      if (cur.order < toast?.order) {\n        return toast;\n      }\n\n      return cur;\n    }, undefined as Toast | undefined);\n  }, [toaster]);\n\n  React.useEffect(() => {\n    if (!targetDocument) {\n      return;\n    }\n\n    const addToastListener = <TType extends keyof ToastListenerMap>(\n      eventType: TType,\n      callback: ToastListenerMap[TType],\n    ) => {\n      const listener: ToastListenerMap[TType] = (e: CustomEvent<CommonToastDetail>) => {\n        if (!isCorrectToaster(e.detail.toasterId)) {\n          return;\n        }\n\n        callback(e as CustomEvent<ShowToastEventDetail>);\n        forceUpdate();\n      };\n\n      targetDocument.addEventListener(eventType, listener as () => void);\n      return () => targetDocument.removeEventListener(eventType, listener as () => void);\n    };\n\n    const buildToast: ToastListenerMap[typeof EVENTS.show] = e => {\n      toaster.buildToast(e.detail, forceUpdate);\n    };\n\n    const dismissToast: ToastListenerMap[typeof EVENTS.dismiss] = e => {\n      toaster.dismissToast(e.detail.toastId);\n    };\n\n    const updateToast: ToastListenerMap[typeof EVENTS.update] = e => {\n      toaster.updateToast(e.detail);\n    };\n\n    const dismissAllToasts: ToastListenerMap[typeof EVENTS.dismissAll] = e => {\n      toaster.dismissAllToasts();\n    };\n\n    const pauseToast: ToastListenerMap[typeof EVENTS.pause] = e => {\n      const toast = toaster.toasts.get(e.detail.toastId);\n      if (toast) {\n        toast.imperativeRef.current?.pause();\n      }\n    };\n\n    const playToast: ToastListenerMap[typeof EVENTS.play] = e => {\n      const toast = toaster.toasts.get(e.detail.toastId);\n      if (toast) {\n        toast.imperativeRef.current?.play();\n      }\n    };\n\n    const cleanupBuildListener = addToastListener(EVENTS.show, buildToast);\n    const cleanupUpdateListener = addToastListener(EVENTS.update, updateToast);\n    const cleanupDismissListener = addToastListener(EVENTS.dismiss, dismissToast);\n    const cleanupDismissAllListener = addToastListener(EVENTS.dismissAll, dismissAllToasts);\n    const cleanupPauseListener = addToastListener(EVENTS.pause, pauseToast);\n    const cleanupPlayListener = addToastListener(EVENTS.play, playToast);\n\n    const focusShortcutListener = (e: KeyboardEvent) => {\n      if (isFocusShortcut(e)) {\n        pauseAllToasts();\n        const mostRecentToast = getMostRecentVisibleToast();\n\n        if (mostRecentToast) {\n          lastActiveElementRef.current = isHTMLElement(targetDocument.activeElement)\n            ? targetDocument.activeElement\n            : null;\n          mostRecentToast.imperativeRef.current?.focus();\n        }\n      }\n    };\n\n    targetDocument.addEventListener('keydown', focusShortcutListener);\n\n    return () => {\n      cleanupBuildListener();\n      cleanupDismissAllListener();\n      cleanupUpdateListener();\n      cleanupDismissListener();\n      cleanupPauseListener();\n      cleanupPlayListener();\n\n      targetDocument.removeEventListener('keydown', focusShortcutListener);\n    };\n  }, [\n    toaster,\n    forceUpdate,\n    targetDocument,\n    isCorrectToaster,\n    pauseAllToasts,\n    getMostRecentVisibleToast,\n    isFocusShortcut,\n  ]);\n\n  const toastsToRender = (() => {\n    if (!toaster) {\n      return new Map<ToastPosition, Toast[]>();\n    }\n\n    const toRender = new Map<ToastPosition, Toast[]>();\n    const toasts = Array.from(toaster.toasts.values());\n\n    toasts.forEach(toast => {\n      const { position } = toast;\n      toRender.has(position) || toRender.set(position, []);\n      if (position.startsWith('bottom')) {\n        toRender.get(position)!.push(toast);\n      } else {\n        toRender.get(position)!.unshift(toast);\n      }\n    });\n\n    return toRender;\n  })();\n\n  return {\n    isToastVisible: toaster.isToastVisible,\n    toastsToRender,\n    pauseAllToasts,\n    playAllToasts,\n    tryRestoreFocus,\n  };\n}\n"],"names":["React","isHTMLElement","useEventCallback","useForceUpdate","useFluent_unstable","useFluent","createToaster","EVENTS","useToaster","options","forceUpdate","toasterId","userToasterId","shortcuts","toaster","useState","targetDocument","lastActiveElementRef","useRef","isCorrectToaster","isFocusShortcut","e","focus","tryRestoreFocus","useCallback","current","pauseAllToasts","visibleToasts","forEach","toastId","toast","toasts","get","imperativeRef","pause","playAllToasts","play","getMostRecentVisibleToast","Array","from","reduce","cur","next","order","undefined","useEffect","addToastListener","eventType","callback","listener","detail","addEventListener","removeEventListener","buildToast","dismissToast","updateToast","dismissAllToasts","pauseToast","playToast","cleanupBuildListener","show","cleanupUpdateListener","update","cleanupDismissListener","dismiss","cleanupDismissAllListener","dismissAll","cleanupPauseListener","cleanupPlayListener","focusShortcutListener","mostRecentToast","activeElement","toastsToRender","Map","toRender","values","position","has","set","startsWith","push","unshift","isToastVisible"],"mappings":"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"}